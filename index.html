<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>アカウント申請フォーム</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* カスタムカラーの簡易再現 */
        .text-package-primary { color: #111; }
        .bg-package-mono-100 { background-color: #f3f4f6; }
        .text-package-red-300 { color: #f87171; }
        /* ローディングアニメーション */
        #loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 9999; justify-content: center; align-items: center; flex-direction: column; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-50">

<div id="loading-overlay">
    <div class="spinner"></div>
    <div id="status-text" class="text-gray-600 font-bold">送信中...</div>
</div>

<div class="flex items-start justify-center py-10 px-4 lg:py-20">
    <div class="w-full max-w-2xl bg-white rounded-2xl shadow-2xl p-8 lg:p-16">
        
        <div class="text-center mb-10">
            <h2 class="text-2xl font-bold text-gray-800">アカウント申請フォーム</h2>
            <p class="text-gray-500 text-sm mt-2">必要な情報を入力してください</p>
        </div>

        <form id="mainForm" class="space-y-6">
            <div class="space-y-2">
                <label class="block text-sm font-medium text-gray-700">代理店番号 <span class="text-xs text-gray-400">※任意</span></label>
                <input type="text" id="agent_no" placeholder="XX00001" class="w-full h-11 border border-gray-300 rounded px-3 bg-gray-50">
            </div>

            <div class="space-y-2">
                <label class="block text-sm font-medium text-gray-700">企業名（屋号） <span class="text-xs text-red-500">※必須</span></label>
                <input type="text" id="company_name" placeholder="企業名(屋号）を入力" class="w-full h-11 border border-gray-300 rounded px-3 bg-gray-50">
            </div>

            <div class="space-y-2">
                <label class="block text-sm font-medium text-gray-700">代表者名 <span class="text-xs text-red-500">※必須</span></label>
                <div class="grid grid-cols-2 gap-4">
                    <input type="text" id="last_name" placeholder="姓" class="w-full h-11 border border-gray-300 rounded px-3 bg-gray-50">
                    <input type="text" id="first_name" placeholder="名" class="w-full h-11 border border-gray-300 rounded px-3 bg-gray-50">
                </div>
            </div>

            <div class="space-y-2">
                <label class="block text-sm font-medium text-gray-700">所在地 <span class="text-xs text-red-500">※必須</span></label>
                <input type="text" id="address" placeholder="〇〇市〇〇区〇〇町1-1-1" class="w-full h-11 border border-gray-300 rounded px-3 bg-gray-50">
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="space-y-2">
                    <label class="block text-sm font-medium text-gray-700">役職 <span class="text-xs text-red-500">※必須</span></label>
                    <input type="text" id="position" placeholder="代表取締役" class="w-full h-11 border border-gray-300 rounded px-3 bg-gray-50">
                </div>
                <div class="space-y-2">
                    <label class="block text-sm font-medium text-gray-700">従業員数 <span class="text-xs text-red-500">※必須</span></label>
                    <select id="employee_count" class="w-full h-11 border border-gray-300 rounded px-3 bg-gray-50">
                        <option value="">選択してください</option>
                        <option value="less_than_10">10名未満</option>
                        <option value="less_than_100">100名未満</option>
                        <option value="less_than_300">300名未満</option>
                        <option value="over_300">300名以上</option>
                        <option value="sole_proprietor">個人事業主</option>
                    </select>
                </div>
            </div>

            <div class="space-y-2">
                <label class="block text-sm font-medium text-gray-700">メールアドレス <span class="text-xs text-red-500">※必須</span></label>
                <input type="email" id="email" placeholder="example@email.com" class="w-full h-11 border border-gray-300 rounded px-3 bg-gray-50">
            </div>
            <div class="space-y-2">
                <label class="block text-sm font-medium text-gray-700">ログイン用メールアドレス <span class="text-xs text-red-500">※必須</span></label>
                <input type="email" id="login_email" placeholder="login@email.com" class="w-full h-11 border border-gray-300 rounded px-3 bg-gray-50">
            </div>

            <div class="pt-6">
                <button type="button" onclick="submitForm()" class="w-full bg-blue-600 text-white font-bold py-3 rounded hover:bg-blue-700 transition duration-300">
                    申し込む
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    // ★★★ GASのURLを設定してください ★★★
    const GAS_API_URL = "https://script.google.com/macros/s/AKfycbyXxxbjJZSPQmerExCvxpRmCFrUhwUi0_JtVUowEoZqTQbyz4qBU4zdqPPxf7LZM6RN/exec";

    async function submitForm() {
        // 1. フォームデータの収集
        const formData = {
            agent_no: document.getElementById('agent_no').value,
            company_name: document.getElementById('company_name').value,
            last_name: document.getElementById('last_name').value,
            first_name: document.getElementById('first_name').value,
            address: document.getElementById('address').value,
            position: document.getElementById('position').value,
            employee_count: document.getElementById('employee_count').value,
            email: document.getElementById('email').value,
            login_email: document.getElementById('login_email').value
        };

        // 簡易バリデーション
        if(!formData.company_name || !formData.last_name || !formData.email) {
            alert("必須項目を入力してください");
            return;
        }

        // 2. 送信処理開始
        const loader = document.getElementById('loading-overlay');
        const statusText = document.getElementById('status-text');
        loader.style.display = 'flex';
        statusText.textContent = "データを送信中...";

        try {
            // GASへPOST送信
            const response = await fetch(GAS_API_URL + "?action=create", {
                method: "POST",
                body: JSON.stringify(formData)
            });
            const json = await response.json();
            
            if (!json.id) throw new Error("ID取得失敗");

            // 3. ポーリング開始
            statusText.textContent = "アカウント準備中...そのままお待ちください";
            pollForUrl(json.id);

        } catch (e) {
            console.error(e);
            alert("エラー: " + e.message);
            loader.style.display = 'none';
        }
    }

    async function pollForUrl(recordId) {
        let attempts = 0;
        const maxAttempts = 20; 

        const interval = setInterval(async () => {
            attempts++;
            // 3秒経ったらメッセージを変えて体感速度をごまかす
            if(attempts > 3) {
                 document.getElementById('status-text').textContent = "最終確認中...";
            }

            try {
                const response = await fetch(`${GAS_API_URL}?action=check&id=${recordId}`);
                const data = await response.json();

                if (data.url) {
                    clearInterval(interval);
                    document.getElementById('status-text').textContent = "完了！リダイレクトします";
                    
                    // 少し待ってからリダイレクト
                    setTimeout(() => {
                        window.location.href = data.url;
                    }, 500);
                } else if (attempts >= maxAttempts) {
                    clearInterval(interval);
                    alert("タイムアウトしました。管理者に問い合わせてください。");
                    document.getElementById('loading-overlay').style.display = 'none';
                }
            } catch (e) {
                console.error("Polling error", e);
            }
        }, 1500);
    }
</script>

</body>
</html>
