<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>外部システム連携デモ</title>
    <style>
        body { font-family: sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; background-color: #f4f7f6; }
        .card { background: white; padding: 40px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 100%; max-width: 400px; text-align: center; }
        input { width: 80%; padding: 10px; margin: 20px 0; border: 1px solid #ddd; border-radius: 5px; font-size: 16px; }
        button { background-color: #3498db; color: white; border: none; padding: 12px 24px; border-radius: 5px; font-size: 16px; cursor: pointer; width: 100%; transition: background 0.3s; }
        button:hover { background-color: #2980b9; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        
        /* ローディング表示 */
        #loading { display: none; margin-top: 20px; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .status-text { color: #666; font-size: 14px; }
    </style>
</head>
<body>

<div class="card" id="form-area">
    <h2>外部システム連携デモ</h2>
    <p>法人名を入力して送信してください。<br>自動的に申込フォームへ遷移します。</p>
    
    <input type="text" id="companyName" placeholder="例: 株式会社サンプル" value="テスト株式会社">
    <button id="submitBtn" onclick="submitForm()">送信して次へ</button>

    <div id="loading">
        <div class="spinner"></div>
        <div class="status-text" id="statusText">処理中...</div>
    </div>
</div>

<script>
    // ★★★ ここにStep1で発行したGASのURLを貼り付ける ★★★
    const GAS_API_URL = "https://script.google.com/macros/s/xxxxxxxxxxxxxxxxx/exec";

    async function submitForm() {
        const name = document.getElementById('companyName').value;
        if(!name) return alert("法人名を入力してください");

        // UI切り替え
        document.getElementById('submitBtn').disabled = true;
        document.getElementById('loading').style.display = 'block';
        updateStatus("Kintoneへデータを送信中...");

        try {
            // 1. レコード作成リクエスト (POST)
            // GASの仕様上、CORSエラー回避のため no-cors モード等は使わず、redirectをfollowさせる
            // 実際はGASのdoPostは特殊な挙動をするため、text/plainで送るのが定石
            const response = await fetch(GAS_API_URL + "?action=create", {
                method: "POST",
                body: JSON.stringify({ company: name })
            });
            
            const json = await response.json();
            const recordId = json.id;
            
            if (!recordId) throw new Error("ID取得失敗");

            updateStatus("URL生成待ち... (ポーリング中)");
            
            // 2. URL監視ループ (ポーリング)
            pollForUrl(recordId);

        } catch (e) {
            console.error(e);
            alert("エラーが発生しました: " + e.message);
            document.getElementById('submitBtn').disabled = false;
            document.getElementById('loading').style.display = 'none';
        }
    }

    async function pollForUrl(recordId) {
        let attempts = 0;
        const maxAttempts = 20; // 最大20回 (約20-30秒)

        const interval = setInterval(async () => {
            attempts++;
            updateStatus(`URL生成待ち... (${attempts}秒経過)`);

            try {
                // GETリクエストで確認
                const response = await fetch(`${GAS_API_URL}?action=check&id=${recordId}`);
                const data = await response.json();

                if (data.url) {
                    clearInterval(interval);
                    updateStatus("完了！リダイレクトします...");
                    
                    // 少しだけ完了メッセージを見せる演出（なくても良い）
                    setTimeout(() => {
                        window.location.href = data.url;
                    }, 500);
                } else if (attempts >= maxAttempts) {
                    clearInterval(interval);
                    alert("タイムアウト：URLが生成されませんでした。");
                    document.getElementById('submitBtn').disabled = false;
                    document.getElementById('loading').style.display = 'none';
                }
            } catch (e) {
                console.error("Polling error", e);
            }
        }, 1500); // 1.5秒ごとに確認
    }

    function updateStatus(msg) {
        document.getElementById('statusText').textContent = msg;
    }
</script>

</body>
</html>
